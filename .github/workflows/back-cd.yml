# actions 名称
name: Docker Stock Back

# 执行时机
on:
  # 监听 push 操作
  push:
    branches:
      - master
    paths:
      - 'apps/back/**'

# 任务
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码 (升级到 v4)
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 替换环境变量 (特定步骤，保持原有逻辑)
      - name: Replace environment variables in .env.production
        run: |
          cat apps/back/.env.production
          sed -i "s|__DB_HOST__|${{ secrets.DB_HOST }}|g" apps/back/.env.production
          sed -i "s|__DB_PORT__|${{ secrets.DB_PORT }}|g" apps/back/.env.production
          sed -i "s|__DB_DATABASE__|${{secrets.DB_DATABASE }}|g" apps/back/.env.production
          sed -i "s|__DB_USERNAME__|${{secrets.DB_USERNAME }}|g" apps/back/.env.production
          sed -i "s|__DB_PASSWORD__|${{secrets.DB_PASSWORD }}|g" apps/back/.env.production
          sed -i "s|__TUSHARE_CONF_TOKEN__|${{secrets.TUSHARE_CONF_TOKEN }}|g" apps/back/.env.production
          cat apps/back/.env.production

      # 3. 登录阿里云镜像容器服务 (使用官方 Action)
      - name: Login to Aliyun Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 构建并推送镜像 (使用官方 Action，支持缓存)
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/back/dockerfile
          push: true
          tags: registry.cn-hangzhou.aliyuncs.com/mufengtongxue/stock-back:latest

      # 5. 远程部署 (使用环境变量传递 Secrets，更安全)
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          # 将敏感信息注入环境变量
          envs: DOCKER_USERNAME,DOCKER_PASSWORD
          # 脚本中不再显式传递参数，而是需要在脚本内读取环境变量
          script: cd /home && sh stock-back-deploy.sh
