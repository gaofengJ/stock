# actions 名称
name: Docker Stock Blog

# 执行时机
on:
  # 监听 push 操作
  # 移除 pull_request，因为代码合并到 master 会自动触发 push 事件
  push:
    branches:
      - master
    paths:
      - 'apps/blog/**'

# 任务
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码 (升级到 v4)
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 安装 pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # 3. 设置 Node.js 环境并开启缓存 (关键优化)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # 4. 安装依赖 (使用 frozen-lockfile 确保依赖版本一致性)
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # 5. 打包项目 (生成静态文件)
      - name: Build Project
        run: pnpm run build:blog

      # 6. 登录阿里云镜像容器服务 (使用官方 Action)
      - name: Login to Aliyun Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 7. 构建并推送镜像 (使用官方 Action，支持缓存)
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: apps/blog
          push: true
          # 保持使用 stock-blog 镜像名，与之前的修改保持一致
          tags: registry.cn-hangzhou.aliyuncs.com/mufengtongxue/stock-blog:latest

      # 8. 远程部署 (使用环境变量传递 Secrets，更安全)
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          # 将敏感信息注入环境变量
          envs: DOCKER_USERNAME,DOCKER_PASSWORD
          # 脚本中不再显式传递参数，而是需要在脚本内读取环境变量
          script: cd /home && sh stock-blog-deploy.sh
